DELETE FROM QUERY_MASTER WHERE CODE='soh_covid19_infrastructure_wise_results';

INSERT INTO public.QUERY_MASTER ( created_by, created_on, modified_by, modified_on, code, params, query, description, returns_result_set, state ) 
VALUES ( 
1,  current_date , 1,  current_date , 'soh_covid19_infrastructure_wise_results', 
 null, 
'select 0 as health_infra_id,
sum(det.member_tested) "PeopleTested",
sum(det.total_sample_tested) "Tests",
sum(det.positive) "Positive",
sum(det.death) "Death",
sum(det.suspected) as "Suspected",
sum(det.discharge) "Discharge",
sum(det.stable_moderate) "Stable",
sum(det.mild) "Mild",
sum(det.critical) "Critical",
sum(det.asymptomatic) "Asymptomatic",
sum(det.active_cases) activecases,
sum(det.on_vantiltor_cases) onVantiltorCases,
sum(det.in_patinets) as "InPatinets",
''Total'' as "Name",
null as "IsCovid19Lab",
null as "IsCovid19Hospital",
sum(det.total_sample_tested) as "TotalSampleTested",
sum(det.total_sample_tested_today) as "TotalSampleTestedToday",
sum(det.total_beds) "TotalBeds",
case when sum(det.total_beds) = 0 then 0 else  round(cast(((sum(det.active_cases)*100/cast(sum(det.total_beds) as float))) as numeric),2) end as "BedsRatio",
sum(det.occupied_bed) "OccupiedBed",
sum(det.available_bed) "AvailableBed",
sum(det.new_added_bed) "NewAddedBed",
sum(det.total_ventilator) "TotalVentilator",
sum(det.new_added_ppe) "NewAddedPPE",
sum(det.new_ppe) "NewPPE",
sum(det.consumed_ppe) "ConsumedPPE",
case when sum(det.total_ventilator) = 0 then 0 else  round(cast(((sum(det.on_vantiltor_cases)*100/cast(sum(det.total_ventilator) as float))) as numeric),2) end as "VentilatorRatio",
sum(det.occupied_ventilator) "OccupiedVentilator",
sum(det.available_ventilator) "AvailableVentilator",
sum(det.new_added_ventilator) "NewAddedVentilator"
from covid19_healthinfra_wise_analytics_details det
union all

select
health_infra_id,
hwad.member_tested "PeopleTested",
hwad.total_sample_tested "Tests",
hwad.positive "Positive",
hwad.death "Death",
hwad.suspected as "Suspected",
hwad.discharge "Discharge",
hwad.stable_moderate "Stable",
hwad.mild "Mild",
hwad.critical "Critical",
hwad.asymptomatic "Asymptomatic",
hwad.active_cases activecases,
hwad.on_vantiltor_cases onVantiltorCases,
hwad.in_patinets as "InPatinets",
name as "Name",
is_covid19_lab as "IsCovid19Lab",
is_covid19_hospital as "IsCovid19Hospital",
hwad.total_sample_tested as "TotalSampleTested",
hwad.total_sample_tested_today as "TotalSampleTestedToday",
hwad.total_beds "TotalBeds",
case when (hwad.total_beds) = 0 then 0 else  round(cast((((hwad.active_cases)*100/cast((hwad.total_beds) as float))) as numeric),2) end as "BedsRatio",
hwad.occupied_bed "OccupiedBed",
hwad.available_bed "AvailableBed",
hwad.new_added_bed "NewAddedBed",
hwad.total_ventilator "TotalVentilator",
hwad.new_added_ppe "NewAddedPPE",
hwad.new_ppe "NewPPE",
hwad.consumed_ppe "ConsumedPPE",
case when hwad.total_ventilator = 0 then 0 else  round(cast((((hwad.on_vantiltor_cases)*100/cast((hwad.total_ventilator) as float))) as numeric),2) end as "VentilatorRatio",
hwad.occupied_ventilator "OccupiedVentilator",
hwad.available_ventilator "AvailableVentilator",
hwad.new_added_ventilator "NewAddedVentilator"
from covid19_healthinfra_wise_analytics_details hwad', 
null, 
true, 'ACTIVE');