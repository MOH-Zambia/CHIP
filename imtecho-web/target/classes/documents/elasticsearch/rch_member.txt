curl -XPUT 'localhost:9200/idx_rch_member' -H 'Content-Type: application/json' -d'
{
  "settings": {
    "analysis": {
      "analyzer": {
        "autocomplete": {
          "tokenizer": "autocomplete",
          "filter": [
            "lowercase"
          ]
        },
        "autocomplete_search": {
          "tokenizer": "lowercase"
        }
      },
      "tokenizer": {
        "autocomplete": {
          "type": "ngram",
          "min_gram": 15,
          "max_gram": 16,
          "token_chars": [
            "letter",
	        "whitespace"
          ]
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "id": {
        "type": "text"
      },
      "health_id": {
        "type": "text",
        "analyzer": "autocomplete",
        "search_analyzer": "autocomplete_search"
      },
      "dob": {
        "type": "text",
        "analyzer": "autocomplete",
        "search_analyzer": "autocomplete_search"
      },
      "name": {
        "type": "text",
        "analyzer": "autocomplete",
        "search_analyzer": "autocomplete_search"
      }
    }
  }
}'

-----------FOR PNC-----------------------

BEGIN

insert
	into
	document_index ( type,
	created_on,
	created_by,
	json)
select
	'idx_rch_member',
	now(),
	-1,
	row_to_json(t)
from
	(
	select
		distinct imt_member.id,
		imt_member.unique_health_id,
		imt_member.dob,
		imt_member.first_name,
		imt_member.middle_name,
		imt_member.last_name,
		'pnc' as type,
		rch_pregnancy_registration_det.current_location_id
	from
		imt_member
	inner join rch_pregnancy_registration_det on
		imt_member.id = rch_pregnancy_registration_det.member_id
	where
		imt_member.id in (
		select
			member_id
		from
			rch_pregnancy_registration_det
		where
			delivery_date > now() - interval '60 days'
			and state = 'DELIVERY_DONE')
		and ((imt_member.basic_state in ('NEW',
		'VERIFIED',
		'REVERIFICATION'))
		or (imt_member.state = 'com.argusoft.imtecho.member.state.temporary'))
		and (imt_member.created_on > (
		select
			to_timestamp(key_value, 'YYYY-MM-DD HH24:MI:SS.US')
		from
			system_configuration
		where
			system_key = 'LAST_INDEX_DATE_OF_RCH_MEMBER_FOR_ELASTICSEARCH')
		or imt_member.modified_on > (
		select
			to_timestamp(key_value, 'YYYY-MM-DD HH24:MI:SS.US')
		from
			system_configuration
		where
			system_key = 'LAST_INDEX_DATE_OF_RCH_MEMBER_FOR_ELASTICSEARCH'))) t;

insert
	into
	document_index ( type,
	created_on,
	created_by,
	json)
select
	'idx_rch_member',
	now(),
	-1,
	row_to_json(t)
from
	(
	select
	imt_member.id,
	imt_member.first_name,
	imt_member.middle_name,
	imt_member.last_name,
	imt_member.unique_health_id,
	imt_member.dob,
	current_location_id,
	'wpd' as type
from
	rch_pregnancy_registration_det,
	imt_member
where
	imt_member.cur_preg_reg_det_id = rch_pregnancy_registration_det.id
	and imt_member.id = rch_pregnancy_registration_det.member_id
	and ((imt_member.basic_state in ('NEW',
	'VERIFIED',
	'REVERIFICATION'))
	or (imt_member.state = 'com.argusoft.imtecho.member.state.temporary'))
	and rch_pregnancy_registration_det.state in ('PREGNANT',
	'PENDING',
	'DELIVERY_DONE')
	and rch_pregnancy_registration_det.edd > now() - interval '2 years'
	and ( (rch_pregnancy_registration_det.state = 'DELIVERY_DONE'
	and rch_pregnancy_registration_det.edd > now() - interval '1 month')
	or rch_pregnancy_registration_det.state != 'DELIVERY_DONE' )
	and (rch_pregnancy_registration_det.reg_date > (
	select
		to_timestamp(key_value, 'YYYY-MM-DD HH24:MI:SS.US')
	from
		system_configuration
	where
		system_key = 'LAST_INDEX_DATE_OF_RCH_MEMBER_FOR_ELASTICSEARCH')) ) t;


update system_configuration set key_value = now() where system_key = 'LAST_INDEX_DATE_OF_RCH_MEMBER_FOR_ELASTICSEARCH'

COMMIT